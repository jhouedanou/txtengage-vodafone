import { ref, onMounted, onUnmounted } from 'vue';

export function useTabletDetection() {
  const isTablet = ref(false);
  const touchStartY = ref(0);
  const touchEndY = ref(0);
  const touchStartTime = ref(0);
  const touchEndTime = ref(0);
  const isProcessingSwipe = ref(false);
  
  // Seuils pour la d√©tection des swipes
  const SWIPE_THRESHOLD = 50; // Distance minimale en pixels
  const SWIPE_TIME_THRESHOLD = 500; // Temps maximum en ms
  const SWIPE_COOLDOWN = 300; // Cooldown entre swipes en ms
  
  let lastSwipeTime = 0;
  let touchEventListeners = [];

  /**
   * D√©tection pr√©cise des tablettes incluant iPadOS 13+
   */
  const detectTablet = () => {
    const userAgent = navigator.userAgent.toLowerCase();
    const platform = navigator.platform?.toLowerCase() || '';
    const maxTouchPoints = navigator.maxTouchPoints || 0;
    
    // D√©tection iPad classique
    const isIpad = /ipad/.test(userAgent) || /macintosh/.test(userAgent);
    
    // D√©tection iPadOS 13+ (qui se fait passer pour macOS)
    const isIpadOS = /macintosh/.test(userAgent) && maxTouchPoints > 1;
    
    // CORRECTION: D√©tection plus pr√©cise des t√©l√©phones pour les exclure
    const isMobilePhone = (
      // iPhones (tous les mod√®les)
      /iphone/.test(userAgent) ||
      // Android phones (avec le mot-cl√© "mobile")
      (/android/.test(userAgent) && /mobile/.test(userAgent)) ||
      // Mod√®les sp√©cifiques de t√©l√©phones Android (sans "mobile" dans l'UA)
      /sm-g\d{3}/.test(userAgent) || // Samsung Galaxy (SM-G981B, etc.)
      /sm-a\d{3}/.test(userAgent) || // Samsung Galaxy A series
      /sm-n\d{3}/.test(userAgent) || // Samsung Galaxy Note series
      /pixel \d/.test(userAgent) ||   // Google Pixel
      /oneplus/.test(userAgent) ||    // OnePlus
      /huawei/.test(userAgent) ||     // Huawei phones
      /xiaomi/.test(userAgent) ||     // Xiaomi phones
      /redmi/.test(userAgent) ||      // Redmi phones
      /oppo/.test(userAgent) ||       // Oppo phones
      /vivo/.test(userAgent) ||       // Vivo phones
      // Dimensions typiques de t√©l√©phones (largeur <= 480px OU ratio > 1.8)
      (window.screen.width <= 480) ||
      (window.screen.height / window.screen.width > 1.8)
    );
    
    // Si c'est d√©tect√© comme un t√©l√©phone, ce n'est PAS une tablette
    if (isMobilePhone) {
      console.log('üì± T√©l√©phone d√©tect√© - utilisation des animations mobiles');
      return false;
    }
    
    // D√©tection tablettes Android (APR√àS avoir exclu les t√©l√©phones)
    const isAndroidTablet = /android/.test(userAgent) && !/mobile/.test(userAgent) && !isMobilePhone;
    
    // D√©tection autres tablettes (Surface, etc.)
    const isOtherTablet = (
      /tablet/.test(userAgent) ||
      /kindle/.test(userAgent) ||
      /silk/.test(userAgent) ||
      /playbook/.test(userAgent) ||
      (platform.includes('win') && maxTouchPoints > 1 && window.screen.width >= 768)
    );
    
    // CORRECTION: D√©tection bas√©e sur les dimensions - PLUS RESTRICTIVE
    const screenWidth = window.screen.width;
    const screenHeight = window.screen.height;
    const hasTouch = 'ontouchstart' in window || maxTouchPoints > 0;
    
    // Pour √™tre une tablette bas√©e sur les dimensions :
    // 1. Doit avoir le tactile
    // 2. Largeur minimale 768px ET maximale 1366px
    // 3. Ratio aspect <= 1.6 (pas de t√©l√©phones longs)
    // 4. Ne doit pas √™tre d√©tect√© comme t√©l√©phone
    const aspectRatio = Math.max(screenWidth, screenHeight) / Math.min(screenWidth, screenHeight);
    const isDimensionTablet = hasTouch && 
      !isMobilePhone && 
      screenWidth >= 768 && 
      screenWidth <= 1366 && 
      aspectRatio <= 1.6;
    
    const result = isIpad || isIpadOS || isAndroidTablet || isOtherTablet || isDimensionTablet;
    
    console.log('üîç D√©tection tablette CORRIG√âE:', {
      userAgent: navigator.userAgent,
      platform: navigator.platform,
      maxTouchPoints,
      screenWidth,
      screenHeight,
      aspectRatio: aspectRatio.toFixed(2),
      isMobilePhone,
      isIpad,
      isIpadOS,
      isAndroidTablet,
      isOtherTablet,
      isDimensionTablet,
      hasTouch,
      result: result ? 'TABLETTE' : 'MOBILE/DESKTOP'
    });
    
    return result;
  };

  /**
   * Configuration des √©v√©nements tactiles pour tablettes
   */
  const setupTouchEvents = () => {
    if (!isTablet.value) return;
    
    console.log('üì± Configuration des √©v√©nements tactiles pour tablette');
    
    const handleTouchStart = (e) => {
      if (isProcessingSwipe.value) return;
      
      touchStartY.value = e.touches[0].clientY;
      touchStartTime.value = Date.now();
    };
    
    const handleTouchMove = (e) => {
      // Emp√™cher le scroll natif pendant le geste
      if (Math.abs(e.touches[0].clientY - touchStartY.value) > 10) {
        e.preventDefault();
      }
    };
    
    const handleTouchEnd = (e) => {
      if (isProcessingSwipe.value) return;
      
      touchEndY.value = e.changedTouches[0].clientY;
      touchEndTime.value = Date.now();
      
      processSwipe();
    };
    
    // Ajouter les √©v√©nements avec passive: false pour pouvoir preventDefault
    document.addEventListener('touchstart', handleTouchStart, { passive: true });
    document.addEventListener('touchmove', handleTouchMove, { passive: false });
    document.addEventListener('touchend', handleTouchEnd, { passive: true });
    
    // Stocker les r√©f√©rences pour le nettoyage
    touchEventListeners = [
      { event: 'touchstart', handler: handleTouchStart },
      { event: 'touchmove', handler: handleTouchMove },
      { event: 'touchend', handler: handleTouchEnd }
    ];
  };

  /**
   * Traitement des swipes et conversion en √©v√©nements scroll
   */
  const processSwipe = () => {
    const currentTime = Date.now();
    
    // V√©rifier le cooldown
    if (currentTime - lastSwipeTime < SWIPE_COOLDOWN) {
      console.log('üö´ Swipe ignor√© - cooldown actif');
      return;
    }
    
    const swipeDistance = touchStartY.value - touchEndY.value;
    const swipeTime = touchEndTime.value - touchStartTime.value;
    
    // Valider le swipe
    if (Math.abs(swipeDistance) < SWIPE_THRESHOLD || swipeTime > SWIPE_TIME_THRESHOLD) {
      return;
    }
    
    isProcessingSwipe.value = true;
    lastSwipeTime = currentTime;
    
    // D√©terminer la direction
    const direction = swipeDistance > 0 ? 'up' : 'down';
    const keyCode = direction === 'up' ? 'ArrowDown' : 'ArrowUp';
    
    console.log(`üëÜ Swipe d√©tect√©: ${direction} (distance: ${Math.abs(swipeDistance)}px, temps: ${swipeTime}ms)`);
    
    // Simuler un √©v√©nement clavier pour d√©clencher le syst√®me de navigation existant
    const keyboardEvent = new KeyboardEvent('keydown', {
      key: keyCode,
      bubbles: true,
      cancelable: true,
      // Ajouter une propri√©t√© custom pour identifier les √©v√©nements tactiles
      detail: { source: 'tablet-swipe' }
    });
    
    // √âmettre l'√©v√©nement sur document
    document.dispatchEvent(keyboardEvent);
    
    // D√©bloquer apr√®s un d√©lai pour √©viter les swipes multiples
    setTimeout(() => {
      isProcessingSwipe.value = false;
    }, SWIPE_COOLDOWN);
  };

  /**
   * Nettoyage des √©v√©nements tactiles
   */
  const cleanupTouchEvents = () => {
    touchEventListeners.forEach(({ event, handler }) => {
      document.removeEventListener(event, handler);
    });
    touchEventListeners = [];
    console.log('üßπ Nettoyage des √©v√©nements tactiles termin√©');
  };

  /**
   * Fonction pour forcer le mode desktop sur tablettes UNIQUEMENT
   */
  const shouldUseDesktopMode = () => {
    // CORRECTION: Utiliser SEULEMENT la d√©tection de tablette
    // Ne plus se baser sur window.innerWidth qui classe les t√©l√©phones comme desktop
    return isTablet.value;
  };

  /**
   * Fonction pour obtenir la taille d'√©cran adapt√©e
   */
  const getResponsiveBreakpoint = () => {
    if (isTablet.value) {
      // Les tablettes utilisent toujours le mode desktop
      return 'desktop';
    }
    
    // CORRECTION: Utiliser une logique plus pr√©cise pour mobile vs desktop
    // V√©rifier d'abord si c'est un t√©l√©phone (qui doit toujours √™tre mobile)
    const userAgent = navigator.userAgent.toLowerCase();
    const isMobilePhone = (
      /iphone/.test(userAgent) ||
      (/android/.test(userAgent) && /mobile/.test(userAgent)) ||
      /sm-g\d{3}/.test(userAgent) || // Samsung Galaxy
      /sm-a\d{3}/.test(userAgent) || // Samsung Galaxy A series
      /sm-n\d{3}/.test(userAgent) || // Samsung Galaxy Note series
      /pixel \d/.test(userAgent) ||   // Google Pixel
      window.screen.width <= 480 ||
      (window.screen.height / window.screen.width > 1.8)
    );
    
    // Si c'est un t√©l√©phone, toujours mobile
    if (isMobilePhone) {
      return 'mobile';
    }
    
    // Pour les vrais ordinateurs/desktop, utiliser 1024px comme seuil
    return window.innerWidth <= 1024 ? 'mobile' : 'desktop';
  };

  /**
   * Initialisation
   */
  const init = () => {
    isTablet.value = detectTablet();
    
    if (isTablet.value) {
      console.log('‚úÖ Tablette d√©tect√©e - Mode desktop activ√© avec gestes tactiles');
      setupTouchEvents();
    } else {
      console.log('üíª Appareil non-tablette d√©tect√©');
    }
  };

  /**
   * Fonction de debug pour tester la d√©tection
   */
  const debugInfo = () => {
    return {
      isTablet: isTablet.value,
      userAgent: navigator.userAgent,
      platform: navigator.platform,
      maxTouchPoints: navigator.maxTouchPoints,
      screenWidth: window.screen.width,
      screenHeight: window.screen.height,
      innerWidth: window.innerWidth,
      innerHeight: window.innerHeight,
      shouldUseDesktop: shouldUseDesktopMode(),
      responsiveBreakpoint: getResponsiveBreakpoint(),
      hasTouch: 'ontouchstart' in window,
      isProcessingSwipe: isProcessingSwipe.value,
      lastSwipeTime,
      timeSinceLastSwipe: Date.now() - lastSwipeTime
    };
  };

  // Exposer les fonctions de debug globalement
  if (typeof window !== 'undefined') {
    window.debugTabletDetection = {
      info: debugInfo,
      detectTablet,
      forceTabletMode: () => {
        isTablet.value = true;
        setupTouchEvents();
        console.log('üîß Mode tablette forc√©');
      },
      disableTabletMode: () => {
        isTablet.value = false;
        cleanupTouchEvents();
        console.log('üîß Mode tablette d√©sactiv√©');
      },
      testSwipe: (direction = 'up') => {
        touchStartY.value = direction === 'up' ? 100 : 0;
        touchEndY.value = direction === 'up' ? 0 : 100;
        touchStartTime.value = Date.now() - 100;
        touchEndTime.value = Date.now();
        processSwipe();
        console.log(`üß™ Test swipe ${direction} simul√©`);
      },
      // NOUVELLE FONCTION: Test de la d√©tection corrig√©e
      testCorrectedDetection: () => {
        console.group('üß™ TEST D√âTECTION CORRIG√âE');
        
        const userAgent = navigator.userAgent;
        const result = detectTablet();
        
        console.log('üì± User Agent:', userAgent);
        console.log('üìè Dimensions √©cran:', window.screen.width + 'x' + window.screen.height);
        console.log('üìê Ratio aspect:', (Math.max(window.screen.width, window.screen.height) / Math.min(window.screen.width, window.screen.height)).toFixed(2));
        console.log('üéØ D√©tection finale:', result ? 'TABLETTE' : 'MOBILE/DESKTOP');
        console.log('üöÄ Animation system:', result ? 'DESKTOP' : 'MOBILE');
        
        // Tests sp√©cifiques
        if (/iphone/.test(userAgent.toLowerCase())) {
          console.log('üì± iPhone d√©tect√©:', !result ? '‚úÖ CORRECT (mobile)' : '‚ùå ERREUR (tablette)');
        }
        if (/android.*mobile/.test(userAgent.toLowerCase())) {
          console.log('üì± Android phone d√©tect√©:', !result ? '‚úÖ CORRECT (mobile)' : '‚ùå ERREUR (tablette)');
        }
        if (/sm-g\d{3}/.test(userAgent.toLowerCase())) {
          console.log('üì± Samsung Galaxy d√©tect√©:', !result ? '‚úÖ CORRECT (mobile)' : '‚ùå ERREUR (tablette)');
        }
        
        console.groupEnd();
        return result;
      }
    };
  }

  return {
    isTablet,
    isProcessingSwipe,
    shouldUseDesktopMode,
    getResponsiveBreakpoint,
    init,
    cleanup: cleanupTouchEvents,
    debugInfo
  };
} 